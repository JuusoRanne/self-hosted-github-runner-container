name: Image Build and Push

on:
  workflow_dispatch:


jobs:
    build-and-push-:
        runs-on: ubuntu-latest

        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v1

          - name: Get latest GitHub Actions runner version
            id: get_runner_version
            run: |
              RUNNER_VERSION=$(curl -s https://api.github.com/repos/actions/runner/releases/latest | jq -r '.tag_name' | sed 's/^v//')
              echo "version=$RUNNER_VERSION" >> $GITHUB_OUTPUT
              echo "Latest GitHub Actions runner version: $RUNNER_VERSION"

          - name: Login to Azure Docker Registry
            uses: azure/docker-login@v2
            with:
              login-server: creuwbfcommonsp.azurecr.io
              username: ${{ secrets.REGISTRY_USERNAME }}
              password: ${{ secrets.REGISTRY_PASSWORD }}

         
          - name: Build and push Docker image
            run: |
              docker build . \
                --platform linux/amd64 \
                --build-arg GITHUB_RUNNER_VERSION=${{ steps.get_runner_version.outputs.version }} \
                -t creuwbfcommonsp.azurecr.io/infrastructure/github-runner:${{ github.sha }}
              docker push creuwbfcommonsp.azurecr.io/infrastructure/github-runner:${{ github.sha }}

          - name: Generate Token
            id: create_token
            uses: tibdex/github-app-token@v2
            with:
              app_id: 1742929
              private_key: ${{ secrets.APP_PRIVATE_KEY }}
              installation_retrieval_mode: repository
              installation_retrieval_payload: businessfinland/bf-self-hosted-github-runner
              revoke: true

          
          - name: Update GitHub variables
            env:
              INSTALLATION_TOKEN: ${{ steps.create_token.outputs.token }}
              TARGET_REPO_NAME: 'businessfinland/bf-self-hosted-github-runner'
            run: |
                # Update CONTAINER_IMAGE_NAME variable
                curl -X PATCH \
                -H "Authorization: Bearer $INSTALLATION_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$TARGET_REPO_NAME/actions/variables/CONTAINER_IMAGE_NAME" \
                -d "{\"value\":\"${{ github.sha }}\"}" \
                || { echo "Failed to update CONTAINER_IMAGE_NAME variable"; exit 1; }

                # Update GITHUB_RUNNER_VERSION variable
                curl -X PATCH \
                -H "Authorization: Bearer $INSTALLATION_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$TARGET_REPO_NAME/actions/variables/GITHUB_RUNNER_VERSION" \
                -d "{\"value\":\"${{ steps.get_runner_version.outputs.version }}\"}" \
                || { echo "Failed to update GITHUB_RUNNER_VERSION variable"; exit 1; }


#          - name: Trigger Deployment Workflow
#            env:
#              INSTALLATION_TOKEN: ${{ steps.create_token.outputs.token }}
#            run: |
#              # Trigger the deployment workflow in the current repository
#              curl -X POST \
#                -H "Authorization: Bearer $INSTALLATION_TOKEN" \
#                -H "Accept: application/vnd.github+json" \
#                "https://api.github.com/repos/${{ github.repository }}/actions/workflows/prod-deploy-infra.yml/dispatches" \
#                -d '{"ref":"main"}' \
#                || { echo "Failed to trigger deployment workflow"; exit 1; }
